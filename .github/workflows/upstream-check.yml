name: Upstream Check

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  determine-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.packages.outputs.packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
      - name: Enumerate packages
        id: packages
        run: |
          set -euo pipefail
          packages=$(./scripts/package.py | awk '/^-/{print $2}' | grep -v '^_')
          PACKAGES="$packages" python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          import os
          pkgs = [p for p in os.environ.get('PACKAGES', '').splitlines() if p]
          print(f"packages={json.dumps(pkgs)}")
          PY

  check:
    needs: determine-packages
    if: ${{ needs.determine-packages.outputs.packages != '[]' }}
    runs-on: ubuntu-latest
    permissions:
      # Needed to commit updates and open PRs.
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install pyyaml
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435
      - name: Check upstream
        id: upstream
        env:
          PACKAGES_JSON: ${{ needs.determine-packages.outputs.packages }}
        run: python3 scripts/check_upstream_ci.py
      - name: Summarize results
        env:
          RESULTS_JSON: ${{ steps.upstream.outputs.results }}
        run: |
          python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
          import json
          import os

          print('#### Upstream check')
          results = json.loads(os.environ.get('RESULTS_JSON') or '[]')
          if not results:
              print('No packages evaluated.')
          else:
              for entry in results:
                  pkg = entry.get('package')
                  status = entry.get('status')
                  latest = entry.get('latest')
                  current = entry.get('current')
                  line = f"- **{pkg}**: {status}"
                  if latest:
                      line += f" (latest {latest}, current {current})"
                  print(line)
          PY
      - name: Apply upstream updates
        if: ${{ steps.upstream.outputs.updates_count != '0' }}
        env:
          UPDATES_JSON: ${{ steps.upstream.outputs.updates }}
        run: python3 scripts/apply_upstream_updates.py

      - name: Detect changes
        if: ${{ steps.upstream.outputs.updates_count != '0' }}
        id: changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Render PR body
        if: ${{ steps.upstream.outputs.updates_count != '0' && steps.changes.outputs.changed == 'true' }}
        env:
          UPDATES_JSON: ${{ steps.upstream.outputs.updates }}
        run: |
          python3 - <<'PY' > pr-body.md
          import json
          import os

          updates = json.loads(os.environ.get('UPDATES_JSON') or '[]')
          lines = []
          for entry in updates:
              pkg = entry.get('package') or 'unknown'
              current = entry.get('current') or 'unknown'
              latest = entry.get('latest') or 'unknown'
              extra = ""
              if pkg == "spark":
                  flavor = entry.get("iceberg_runtime_flavor")
                  iceberg = entry.get("iceberg_version")
                  if flavor or iceberg:
                      extra = f" (iceberg {iceberg or 'unknown'}, flavor {flavor or 'unknown'})"
              lines.append(f"- **{pkg}**: {current} â†’ {latest}{extra}")

          body = [
              "The scheduled upstream check detected new releases:",
              "",
              *lines,
              "",
              "Please review and adjust Dockerfiles/build args as needed (e.g., Spark Iceberg runtime flavor).",
          ]
          print("\n".join(body))
          PY

      - name: Create or update PR
        if: ${{ steps.upstream.outputs.updates_count != '0' && steps.changes.outputs.changed == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: apply upstream version updates"
          title: "Upstream version updates"
          body-path: pr-body.md
          branch: upstream-updates
          labels: upstream-update
